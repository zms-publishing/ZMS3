<?xml version="1.0" encoding="utf-8"?>

<list>
  <item type="dictionary">
    <dictionary>
      <item key="key"><![CDATA[ZMSIndex]]></item>
      <item key="value" type="dictionary">
        <dictionary>
          <item key="__obj_attrs__" type="list">
            <list>
              <item type="dictionary">
                <dictionary>
                  <item key="id"><![CDATA[_index]]></item>
                  <item key="mandatory" type="int">1</item>
                  <item key="multilang" type="int">0</item>
                  <item key="name"><![CDATA[Index]]></item>
                  <item key="repetitive" type="int">0</item>
                  <item key="type"><![CDATA[list]]></item>
                </dictionary>
              </item>
              <item type="dictionary">
                <dictionary>
                  <item key="id"><![CDATA[interface0]]></item>
                  <item key="mandatory" type="int">0</item>
                  <item key="multilang" type="int">0</item>
                  <item key="name"><![CDATA[<tal:block tal:define="zmscontext options/zmscontext">
<script>
function zmsIndexReindexBtnClick(sender) {
  $(sender).closest('form').append('<'+'input type="hidden" name="manage_target" value="'+self.location.href+'"/>');
}
function zmsIndexSearchBtnClick(sender) {
  $(sender).closest('form').attr({action:self.location.href,method:'GET'});
}
</script>
<div class="form-group">
  <label class="col-sm-2">Index</label>
  <div class="col-sm-1">
    <tal:block tal:content="python:len(zmscontext.attr('_index'))">len(_index)</tal:block>
    <tal:block tal:content="python:zmscontext.getZMILangStr('ATTR_OBJECTS')">Objects</tal:block>
  </div>
  <div class="col-sm-1">
    <button class="btn btn-danger" name="btn" value="reindex" onclick="zmsIndexReindexBtnClick(this)">Reindex</button>
  </div>
</div><!-- .form-group -->
<div class="form-group">
  <label class="col-sm-2">Id</label>
  <div class="col-sm-6">
  <div class="input-group">
    <input id="search_term" class="form-control" type="text" tal:attributes="value python:request.get('search_term','')" size="15" name="search_term"/>
    <span class="input-group-btn">
      <button class="btn btn-primary" name="btn" value="search" onclick="zmsIndexSearchBtnClick(this)">
        <tal:block tal:content="structure python:zmscontext.zmi_icon(name='icon-search')">icon-search</tal:block>
      </button>
    </span>
    </div><!-- .input-group -->
  </div>
</div><!-- .form-group -->
<tal:block tal:condition="python:request.has_key('search_term','')">
<div class="form-group">
  <label class="col-sm-2">Link-Url</label>
  <div class="col-sm-6">
  <div class="input-group" tal:define="ref python:zmscontext.getLinkObj('{$%s}'%request['search_term'],request)">
    <code tal:condition="python:ref is None">not found</code>
    <code tal:condition="python:ref is not None"><a tal:attributes="href python:'%s/manage_main'%ref.absolute_url()" target="_blank" tal:content="python:zmscontext.getRefObjPath(ref)">the link-url</a></code>
    <code tal:content="python:filter(lambda x:x['zmsid']==request['search_term'],zmscontext.attr('_index'))">the index</code>
    <code tal:content="python:zmscontext.attr('_index')">the index</code>
  </div>
</div><!-- .form-group -->
</tal:block>
</tal:block>]]>
                  </item>
                  <item key="repetitive" type="int">0</item>
                  <item key="type"><![CDATA[interface]]></item>
                </dictionary>
              </item>
              <item type="dictionary">
                <dictionary>
                  <item key="custom"><![CDATA[## Script (Python) "ZMSIndex.getLinkObj"
##bind container=container
##bind context=context
##bind namespace=
##bind script=script
##bind subpath=traverse_subpath
##parameters=zmscontext=None,options=None
##title=py: Hook: Get link object
##
# --// getLinkObj //--

obj = None
url = options['url']
if url.startswith('{$') and url.endswith('}'):
  url = url[2:-1]
  zmsid = url.split('/')[-1]
  docelmnt = zmscontext.getDocumentElement()
  index = docelmnt.zmsindex.attr('_index')
  row = filter(lambda x:x['zmsid']==zmsid,index)
  if len(row)==1:
    l = []
    while len(row) == 1:
      zmscontext.writeStdout('[getLinkObj]: zmsid='+str(zmsid))
      l.insert(0,zmsid)
      zmsid = row[0]['zmsparent']
      row = filter(lambda x:x['zmsid']==zmsid,index)
    obj = docelmnt
    l = l[1:]
    while obj is not None and len(l) > 0:
      obj = getattr(obj,l[0],None)
      l = l[1:]
return obj

# --// /getLinkObj //--
]]>
                  </item>
                  <item key="id"><![CDATA[getLinkObj]]></item>
                  <item key="mandatory" type="int">0</item>
                  <item key="multilang" type="int">0</item>
                  <item key="name"><![CDATA[Hook: Get link object]]></item>
                  <item key="repetitive" type="int">0</item>
                  <item key="type"><![CDATA[py]]></item>
                </dictionary>
              </item>
              <item type="dictionary">
                <dictionary>
                  <item key="custom"><![CDATA[## Script (Python) "ZMSIndex.set_parent_oid"
##bind container=container
##bind context=context
##bind namespace=
##bind script=script
##bind subpath=traverse_subpath
##parameters=zmscontext=None
##title=py: Event: set parent oid
##
# --// set_parent_oid //--

docelmnt = zmscontext.getDocumentElement()
index = docelmnt.zmsindex.attr('_index')
for node in zmscontext.getChildNodes():
  row = filter(lambda x:x['zmsid']==node.id,index)
  if len(row) == 0:
    d = {}
    d['zmsroot'] = node.getHome().id
    d['zmsid'] = node.id
    d['zmsmeta_id'] = node.meta_id
    d['zmsoid'] = node.get_oid()
    index.append(d)
  else:
    d = row[0]
  d['zmsparent'] = node.aq_parent.id
docelmnt.zmsindex.attr('_index',index)

# --// /set_parent_oid //--
]]>
                  </item>
                  <item key="id"><![CDATA[set_parent_oid]]></item>
                  <item key="mandatory" type="int">0</item>
                  <item key="multilang" type="int">0</item>
                  <item key="name"><![CDATA[Event: set parent oid]]></item>
                  <item key="repetitive" type="int">0</item>
                  <item key="type"><![CDATA[py]]></item>
                </dictionary>
              </item>
              <item type="dictionary">
                <dictionary>
                  <item key="custom"><![CDATA[## Script (Python) "ZMSIndex.unset_parent_oid"
##bind container=container
##bind context=context
##bind namespace=
##bind script=script
##bind subpath=traverse_subpath
##parameters=zmscontext=None
##title=py: Event: unset parent oid
##
# --// unset_parent_oid //--

docelmnt = zmscontext.getDocumentElement()
index = docelmnt.zmsindex.attr('_index')
index = filter(lambda x:x['zmsid']!=node.id,index)
docelmnt.zmsindex.attr('_index',index)

# --// /unset_parent_oid //--
]]>
                  </item>
                  <item key="id"><![CDATA[unset_parent_oid]]></item>
                  <item key="mandatory" type="int">0</item>
                  <item key="multilang" type="int">0</item>
                  <item key="name"><![CDATA[Event: unset parent oid]]></item>
                  <item key="repetitive" type="int">0</item>
                  <item key="type"><![CDATA[py]]></item>
                </dictionary>
              </item>
              <item type="dictionary">
                <dictionary>
                  <item key="custom"><![CDATA[## Script (Python) "ZMSIndex.onChangeObjEvt"
##bind container=container
##bind context=context
##bind namespace=
##bind script=script
##bind subpath=traverse_subpath
##parameters=zmscontext=None
##title=py: Event: On change object
##
# --// onChangeObjEvt //--

request = container.REQUEST
RESPONSE =  request.RESPONSE
zmscontext.writeStdout('[onChangeObjEvt] '+str(zmscontext)+' '+str(request.get('btn')))
if zmscontext.meta_id=='ZMSIndex' and request.get('btn')=='reindex':
  zmscontext.attr('_index',[])
  l = zmscontext.getDocumentElement().sync_oids()
  zmscontext.writeStdout('[onChangeObjEvt] reindex='+str(l))

# --// /onChangeObjEvt //--
]]>
                  </item>
                  <item key="id"><![CDATA[onChangeObjEvt]]></item>
                  <item key="mandatory" type="int">0</item>
                  <item key="multilang" type="int">0</item>
                  <item key="name"><![CDATA[Event: On change object]]></item>
                  <item key="repetitive" type="int">0</item>
                  <item key="type"><![CDATA[py]]></item>
                </dictionary>
              </item>
            </list>
          </item>
          <item key="access" type="dictionary">
            <dictionary>
              <item key="delete" type="list">
                <list>
                  <item><![CDATA[ZMSAdministrator]]></item>
                  <item><![CDATA[ZMSAuthor]]></item>
                  <item><![CDATA[ZMSEditor]]></item>
                </list>
              </item>
              <item key="delete_custom"></item>
              <item key="insert" type="list">
                <list>
                  <item><![CDATA[ZMSAdministrator]]></item>
                  <item><![CDATA[ZMSAuthor]]></item>
                  <item><![CDATA[ZMSEditor]]></item>
                </list>
              </item>
              <item key="insert_custom"><![CDATA[{$}]]></item>
            </dictionary>
          </item>
          <item key="enabled" type="int">0</item>
          <item key="id"><![CDATA[ZMSIndex]]></item>
          <item key="name"><![CDATA[ZMSIndex]]></item>
          <item key="package"><![CDATA[com.zms.index]]></item>
          <item key="revision"><![CDATA[0.0.1]]></item>
          <item key="type"><![CDATA[ZMSResource]]></item>
        </dictionary>
      </item>
    </dictionary>
  </item>
  <item type="dictionary">
    <dictionary>
      <item key="key"><![CDATA[com.zms.index]]></item>
      <item key="value" type="dictionary">
        <dictionary>
          <item key="__obj_attrs__" type="list">
            <list>
            </list>
          </item>
          <item key="access" type="dictionary">
            <dictionary>
              <item key="delete" type="list">
                <list>
                </list>
              </item>
              <item key="delete_custom"></item>
              <item key="insert" type="list">
                <list>
                </list>
              </item>
              <item key="insert_custom"></item>
            </dictionary>
          </item>
          <item key="enabled" type="int">0</item>
          <item key="id"><![CDATA[com.zms.index]]></item>
          <item key="name"><![CDATA[com.zms.index]]></item>
          <item key="package"></item>
          <item key="revision"><![CDATA[0.0.1]]></item>
          <item key="type"><![CDATA[ZMSPackage]]></item>
        </dictionary>
      </item>
    </dictionary>
  </item>
</list>