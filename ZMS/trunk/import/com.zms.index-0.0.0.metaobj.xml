<?xml version="1.0" encoding="utf-8"?>

<list>
  <item type="dictionary">
    <dictionary>
      <item key="key"><![CDATA[ZMSIndex]]></item>
      <item key="value" type="dictionary">
        <dictionary>
          <item key="__obj_attrs__" type="list">
            <list>
              <item type="dictionary">
                <dictionary>
                  <item key="id"><![CDATA[_index]]></item>
                  <item key="mandatory" type="int">1</item>
                  <item key="multilang" type="int">0</item>
                  <item key="name"><![CDATA[Index]]></item>
                  <item key="repetitive" type="int">0</item>
                  <item key="type"><![CDATA[list]]></item>
                </dictionary>
              </item>
              <item type="dictionary">
                <dictionary>
                  <item key="id"><![CDATA[interface0]]></item>
                  <item key="mandatory" type="int">0</item>
                  <item key="multilang" type="int">0</item>
                  <item key="name"><![CDATA[<tal:block tal:define="zmscontext options/zmscontext">
<div class="form-group">
  <label class="col-sm-2">Index</label>
  <div class="col-sm-10">
    <tal:block tal:content="python:len(zmscontext.attr('_index'))">len(_index)</tal:block>
    <tal:block tal:content="python:zmscontext.getZMILangStr('ATTR_OBJECTS')">Objects</tal:block>
  </div>
</div><!-- .form-group -->
<div class="form-group">
  <label class="col-sm-2"></label>
  <div class="col-sm-10">
    <button class="btn btn-danger" name="btn" value="reindex">Reindex</button>
  </div>
</div><!-- .form-group -->
</tal:block>]]>
                  </item>
                  <item key="repetitive" type="int">0</item>
                  <item key="type"><![CDATA[interface]]></item>
                </dictionary>
              </item>
              <item type="dictionary">
                <dictionary>
                  <item key="custom"><![CDATA[## Script (Python) "ZMSIndex.getLinkObj"
##bind container=container
##bind context=context
##bind namespace=
##bind script=script
##bind subpath=traverse_subpath
##parameters=zmscontext=None,options=None
##title=py: Hook: Get link object
##
# --// getLinkObj //--

url = options['url']
if url.startswith('{$') and url.endswith('}'):
  url = url[2:-1]
  zmsid = url.split('/')[-1]
  index = zmscontext.getDocumentElement().zmsindex.attr('_index')
  row = filter(lambda x:x['zmsid']==zmsid,index)
  if len(row)==1:
    l = []
    while len(row) == 1:
      l.insert(0,zmsid)
      zmsid = row[0]['zmsparent']
      row = filter(lambda x:x['zmsid']==zmsid,index)
    url = '{$%s}'%'/'.join(l[1:])
  else:
    url = '{$__%s__}'%url
return url

# --// /getLinkObj //--
]]>
                  </item>
                  <item key="id"><![CDATA[getLinkObj]]></item>
                  <item key="mandatory" type="int">0</item>
                  <item key="multilang" type="int">0</item>
                  <item key="name"><![CDATA[Hook: Get link object]]></item>
                  <item key="repetitive" type="int">0</item>
                  <item key="type"><![CDATA[py]]></item>
                </dictionary>
              </item>
              <item type="dictionary">
                <dictionary>
                  <item key="custom"><![CDATA[## Script (Python) "ZMSIndex.afterCopyObjEvt"
##bind container=container
##bind context=context
##bind namespace=
##bind script=script
##bind subpath=traverse_subpath
##parameters=zmscontext=None
##title=py: Event: After copy object
##
# --// afterCopyObjEvt //--
# Example code:

# Import a standard function, and get the HTML request and response objects.
from Products.PythonScripts.standard import html_quote
request = container.REQUEST
RESPONSE =  request.RESPONSE

# Return a string identifying this script.
print "This is the", script.meta_type, '"%s"' % script.getId(),
if script.title:
    print "(%s)" % html_quote(script.title),
print "in", container.absolute_url()
return printed

# --// /afterCopyObjEvt //--
]]>
                  </item>
                  <item key="id"><![CDATA[afterCopyObjEvt]]></item>
                  <item key="mandatory" type="int">0</item>
                  <item key="multilang" type="int">0</item>
                  <item key="name"><![CDATA[Event: After copy object]]></item>
                  <item key="repetitive" type="int">0</item>
                  <item key="type"><![CDATA[py]]></item>
                </dictionary>
              </item>
              <item type="dictionary">
                <dictionary>
                  <item key="custom"><![CDATA[## Script (Python) "ZMSIndex.afterMoveObjEvt"
##bind container=container
##bind context=context
##bind namespace=
##bind script=script
##bind subpath=traverse_subpath
##parameters=zmscontext=None
##title=py: Event: After move object
##
# --// afterMoveObjEvt //--
# Example code:

# Import a standard function, and get the HTML request and response objects.
from Products.PythonScripts.standard import html_quote
request = container.REQUEST
RESPONSE =  request.RESPONSE

# Return a string identifying this script.
print "This is the", script.meta_type, '"%s"' % script.getId(),
if script.title:
    print "(%s)" % html_quote(script.title),
print "in", container.absolute_url()
return printed

# --// /afterMoveObjEvt //--
]]>
                  </item>
                  <item key="id"><![CDATA[afterMoveObjEvt]]></item>
                  <item key="mandatory" type="int">0</item>
                  <item key="multilang" type="int">0</item>
                  <item key="name"><![CDATA[Event: After move object]]></item>
                  <item key="repetitive" type="int">0</item>
                  <item key="type"><![CDATA[py]]></item>
                </dictionary>
              </item>
              <item type="dictionary">
                <dictionary>
                  <item key="custom"><![CDATA[## Script (Python) "ZMSIndex.onChangeObjEvt"
##bind container=container
##bind context=context
##bind namespace=
##bind script=script
##bind subpath=traverse_subpath
##parameters=zmscontext=None
##title=py: Event: On change object
##
# --// onChangeObjEvt //--

request = container.REQUEST
RESPONSE =  request.RESPONSE
zmscontext.writeStdout('[onChangeObjEvt] '+str(zmscontext)+' '+str(request.get('btn')))
if zmscontext.meta_id=='ZMSIndex' and request.get('btn')=='reindex':
  l = []
  def visit(node,parent_id):
    d = {}
    d['zmsroot'] = node.getHome().id
    d['zmsid'] = node.id
    d['zmsmeta_id'] = node.meta_id
    d['zmsparent'] = parent_id
    l.append(d)
    for childNode in node.getChildNodes():
      visit(childNode,node.id)
  visit(zmscontext.getDocumentElement(),None)
  zmscontext.attr('_index',l)
  zmscontext.writeStdout('[onChangeObjEvt] reindex='+str(l))

# --// /onChangeObjEvt //--
]]>
                  </item>
                  <item key="id"><![CDATA[onChangeObjEvt]]></item>
                  <item key="mandatory" type="int">0</item>
                  <item key="multilang" type="int">0</item>
                  <item key="name"><![CDATA[Event: On change object]]></item>
                  <item key="repetitive" type="int">0</item>
                  <item key="type"><![CDATA[py]]></item>
                </dictionary>
              </item>
            </list>
          </item>
          <item key="access" type="dictionary">
            <dictionary>
              <item key="delete" type="list">
                <list>
                  <item><![CDATA[ZMSAdministrator]]></item>
                  <item><![CDATA[ZMSAuthor]]></item>
                  <item><![CDATA[ZMSEditor]]></item>
                </list>
              </item>
              <item key="delete_custom"></item>
              <item key="insert" type="list">
                <list>
                  <item><![CDATA[ZMSAdministrator]]></item>
                  <item><![CDATA[ZMSAuthor]]></item>
                  <item><![CDATA[ZMSEditor]]></item>
                </list>
              </item>
              <item key="insert_custom"><![CDATA[{$}]]></item>
            </dictionary>
          </item>
          <item key="enabled" type="int">1</item>
          <item key="id"><![CDATA[ZMSIndex]]></item>
          <item key="name"><![CDATA[ZMSIndex]]></item>
          <item key="package"><![CDATA[com.zms.index]]></item>
          <item key="revision"><![CDATA[0.0.0]]></item>
          <item key="type"><![CDATA[ZMSResource]]></item>
        </dictionary>
      </item>
    </dictionary>
  </item>
  <item type="dictionary">
    <dictionary>
      <item key="key"><![CDATA[com.zms.index]]></item>
      <item key="value" type="dictionary">
        <dictionary>
          <item key="__obj_attrs__" type="list">
            <list>
            </list>
          </item>
          <item key="enabled" type="int">1</item>
          <item key="id"><![CDATA[com.zms.index]]></item>
          <item key="name"><![CDATA[com.zms.index]]></item>
          <item key="package"></item>
          <item key="revision"><![CDATA[0.0.0]]></item>
          <item key="type"><![CDATA[ZMSPackage]]></item>
        </dictionary>
      </item>
    </dictionary>
  </item>
</list>