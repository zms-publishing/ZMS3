<!DOCTYPE html>
<html lang="en">
<tal:block tal:content="structure python:here.zmi_html_head(here,request)">zmi_html_head</tal:block>
<body tal:attributes="class python:here.zmi_body_class(id='lazy_select_form')">

<tal:block tal:define="global
			entity python:here.getEntity(request['qentity']);
			encoding python:getattr(here,'charset','utf-8');
			dummy0 python:request.set('qstart',request.get('qstart',request.SESSION.get('qstart_%s'%id,0)));
			dummy0 python:request.set('qbatch',request.get('qbatch',request.SESSION.get('qbatch_%s'%id,3)));
			dummy0 python:request.set('qsize',request.get('qsize',request.SESSION.get('qsize_%s'%id,20)));
			dummy0 python:request.set('qindex',request.get('qindex',request.SESSION.get('qindex_%s'%id,-1)));
			dummy0 python:request.set('qstart_%s'%here.id,request.get('qstart'));
			dummy0 python:request.set('qbatch_%s'%here.id,request.get('qbatch'));
			whereClause python:['1=1']">

<form method="get" class="form-horizontal" style="background:#DCE3F0">
	<input type="hidden" name="id" tal:attributes="value request/id">
	<input type="hidden" name="lang" tal:attributes="value request/lang">
	<input type="hidden" name="preview" tal:attributes="value request/preview">
	<input type="hidden" name="qstart" tal:attributes="value request/qstart">
	<input type="hidden" name="qentity" tal:attributes="value request/qentity">
				<div class="form-group col-lg-12" tal:repeat="filterIndex python:range(len(request['qcolumns']))">
					<input type="hidden" name="qcolumns:list" tal:attributes="value python:request['qcolumns'][filterIndex]"/>
					<tal:block tal:condition="python:request.get('filtervalue%i'%filterIndex,'')!=''">
						<tal:block tal:define="global dummy0 python:whereClause.append('%s %s %s'%(request['filterattr%i'%filterIndex],request['filterop%i'%filterIndex],here.sql_quote__(request['qentity'],request['filterattr%i'%filterIndex],request['filtervalue%i'%filterIndex])))"></tal:block>
					</tal:block>
					<div class="pull-left"><select class="form-control input-sm" tal:attributes="name python:'filterattr%i'%filterIndex">
						<tal:block tal:repeat="column python:filter(lambda x:x['id'].upper()==request['qcolumns'][filterIndex].upper(),entity['columns'])">
							<option tal:attributes="value column/id; selected python:['','selected'][int(column['id'].lower()==request.get('filterattr%i'%filterIndex,'').lower())]" tal:content="column/label">column</option>
						</tal:block>
					</select></div>
					<div class="pull-left"><select class="form-control input-sm" tal:attributes="name python:'filterop%i'%filterIndex">
						<tal:block tal:repeat="op python:['LIKE','=','<','<=','>','>=','NULL','NOT NULL']">
							<option tal:attributes="value python:op; selected python:['','selected'][op.lower()==request.get('filterop%i'%filterIndex,'').lower()]" tal:content="python:op">op</option>
						</tal:block>
					</select></div>
					<div class="pull-left"><input class="form-control input-sm" type="text" tal:attributes="name python:'filtervalue%i'%filterIndex; value python:request.get('filtervalue%i'%filterIndex,'')" /></div>
					<div class="pull-left">
						<button type="submit" class="btn btn-primary" name="btn" tal:attributes="value python:here.getZMILangStr('BTN_REFRESH')">
							<tal:block tal:content="structure python:here.zmi_icon(name='icon-search')"></tal:block>
						</button>
					</div>
				</div><!-- .form-group -->
</form>

	<tal:block tal:define="global
			resSlctStmnt python:'SELECT * FROM '+entity['id']+' WHERE '+' AND '.join(whereClause)+' ORDER BY '+','.join(request['qcolumns']);
			query python:here.query(resSlctStmnt,encoding=encoding);
			pk python:here.getEntityPK(entity['id']);
			metaObjAttrIds python:[pk]+request['qcolumns'];
			metaObjAttrs python:filter(lambda x:x['id'].upper() in map(lambda x2:x2.upper(),metaObjAttrIds),entity['columns']);
			dummy0 python:map(lambda x:here.operator_setitem(x,'name',x['label']),metaObjAttrs);
			res python:query['records'];
			dummy0 python:map(lambda x:here.operator_setitem(x,'__id__',here.operator_getitem(x,pk,ignorecase=True)),res)">
	<tal:block tal:content="structure python:here.metaobj_recordset_main_grid(metaObjAttrIds=metaObjAttrIds,metaObjAttrs=filter(lambda x:x.get('id') in metaObjAttrIds or x.get('hide',0)==0,metaObjAttrs),filtered_records=res,records=res,url_params={'id':request['id'],'qentity':request['qentity']},actions=request.get('actions',[]))">
		metaobj_recordset_main_grid
	</tal:block>
</tal:block>

	<div class="form-group">
		<div class="controls save">
			<button type="submit" name="btn" class="btn btn-primary" onclick="zmiSelectBtnClick()" tal:attributes="value python:here.getZMILangStr('BTN_SELECT')" tal:content="python:here.getZMILangStr('BTN_SELECT')">Select</button>
			<button type="submit" name="btn" class="btn btn-default" onclick="zmiCloseBtnClick()" tal:attributes="value python:here.getZMILangStr('BTN_CLOSE')" tal:content="python:here.getZMILangStr('BTN_CLOSE')">Close</button>
		</div><!-- .col-sm-9 col-md-10 -->
	</div><!-- .form-group -->

<tal:block tal:content="structure python:'<script>'"></tal:block>
function zmiSelectBtnClick() {
	$("input:checked").each(function() {
			var value = $(this).val();
			var $tr = $(this).closest("tr");
			var label = $("td:last",$tr).text().trim();
			window.parent.zmiLazySelect('<tal:block tal:content="request/id">the id</tal:block>',{label:label,value:value});
		});
	zmiCloseBtnClick();
}
function zmiCloseBtnClick() {
	window.parent.zmiDialogClose();
}
<tal:block tal:content="structure python:'</script>'"></tal:block>

</tal:block>

<tal:block tal:content="structure python:here.zmi_html_foot(here,request)">zmi_html_foot</tal:block>
</body>
</html>